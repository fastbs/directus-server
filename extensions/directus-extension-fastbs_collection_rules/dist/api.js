import t from"util";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var r=(t,e,n=500)=>class extends Error{name="DirectusError";extensions;code=t.toUpperCase();status=n;constructor(t,n){super("string"==typeof e?e:e(t),n),this.extensions=t}toString(){return`${this.name} [${this.code}]: ${this.message}`}},o="__lodash_hash_undefined__",a=1/0,i="[object Function]",c="[object GeneratorFunction]",s="[object Symbol]",l=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,u=/^\w*$/,f=/^\./,p=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,h=/\\(\\)?/g,_=/^\[object .+?Constructor\]$/,y="object"==typeof e&&e&&e.Object===Object&&e,d="object"==typeof self&&self&&self.Object===Object&&self,v=y||d||Function("return this")();var g,b=Array.prototype,m=Function.prototype,w=Object.prototype,E=v["__core-js_shared__"],O=(g=/[^.]+$/.exec(E&&E.keys&&E.keys.IE_PROTO||""))?"Symbol(src)_1."+g:"",$=m.toString,j=w.hasOwnProperty,S=w.toString,A=RegExp("^"+$.call(j).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),R=v.Symbol,T=b.splice,C=F(v,"Map"),D=F(Object,"create"),L=R?R.prototype:void 0,U=L?L.toString:void 0;function x(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function P(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function k(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function M(t,e){for(var n,r,o=t.length;o--;)if((n=t[o][0])===(r=e)||n!=n&&r!=r)return o;return-1}function N(t,e){var n;e=function(t,e){if(G(t))return!1;var n=typeof t;if("number"==n||"symbol"==n||"boolean"==n||null==t||V(t))return!0;return u.test(t)||!l.test(t)||null!=e&&t in Object(e)}(e,t)?[e]:G(n=e)?n:Y(n);for(var r=0,o=e.length;null!=t&&r<o;)t=t[q(e[r++])];return r&&r==o?t:void 0}function B(t){if(!K(t)||(e=t,O&&O in e))return!1;var e,n=function(t){var e=K(t)?S.call(t):"";return e==i||e==c}(t)||function(t){var e=!1;if(null!=t&&"function"!=typeof t.toString)try{e=!!(t+"")}catch(t){}return e}(t)?A:_;return n.test(function(t){if(null!=t){try{return $.call(t)}catch(t){}try{return t+""}catch(t){}}return""}(t))}function I(t,e){var n,r,o=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof e?"string":"hash"]:o.map}function F(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return B(n)?n:void 0}x.prototype.clear=function(){this.__data__=D?D(null):{}},x.prototype.delete=function(t){return this.has(t)&&delete this.__data__[t]},x.prototype.get=function(t){var e=this.__data__;if(D){var n=e[t];return n===o?void 0:n}return j.call(e,t)?e[t]:void 0},x.prototype.has=function(t){var e=this.__data__;return D?void 0!==e[t]:j.call(e,t)},x.prototype.set=function(t,e){return this.__data__[t]=D&&void 0===e?o:e,this},P.prototype.clear=function(){this.__data__=[]},P.prototype.delete=function(t){var e=this.__data__,n=M(e,t);return!(n<0)&&(n==e.length-1?e.pop():T.call(e,n,1),!0)},P.prototype.get=function(t){var e=this.__data__,n=M(e,t);return n<0?void 0:e[n][1]},P.prototype.has=function(t){return M(this.__data__,t)>-1},P.prototype.set=function(t,e){var n=this.__data__,r=M(n,t);return r<0?n.push([t,e]):n[r][1]=e,this},k.prototype.clear=function(){this.__data__={hash:new x,map:new(C||P),string:new x}},k.prototype.delete=function(t){return I(this,t).delete(t)},k.prototype.get=function(t){return I(this,t).get(t)},k.prototype.has=function(t){return I(this,t).has(t)},k.prototype.set=function(t,e){return I(this,t).set(t,e),this};var Y=Q((function(t){var e;t=null==(e=t)?"":function(t){if("string"==typeof t)return t;if(V(t))return U?U.call(t):"";var e=t+"";return"0"==e&&1/t==-a?"-0":e}(e);var n=[];return f.test(t)&&n.push(""),t.replace(p,(function(t,e,r,o){n.push(r?o.replace(h,"$1"):e||t)})),n}));function q(t){if("string"==typeof t||V(t))return t;var e=t+"";return"0"==e&&1/t==-a?"-0":e}function Q(t,e){if("function"!=typeof t||e&&"function"!=typeof e)throw new TypeError("Expected a function");var n=function(){var r=arguments,o=e?e.apply(this,r):r[0],a=n.cache;if(a.has(o))return a.get(o);var i=t.apply(this,r);return n.cache=a.set(o,i),i};return n.cache=new(Q.Cache||k),n}Q.Cache=k;var G=Array.isArray;function K(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function V(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&S.call(t)==s}var W=n((function(t,e,n){var r=null==t?void 0:N(t,e);return void 0===r?n:r}));const z=[{name:"fastbs.hook",config:async({filter:e,action:n},o)=>{console.log("************* Enter fastbs.hook ************* ");const{database:a}=o,{ItemsService:i}=o.services,c=o.env.DB_FASTBS_BUNDLE_SETTINGS_COLLECTION??"",s=(await a.select().from(c))[0];t.inspect.defaultOptions.depth=null;const l={};function u(t){const e=/^\s*{{\s*((\$\w+)(\.\w+)*)\s*}}\s*$/gi;if(t instanceof Object)for(const n in t)if(t[n]instanceof Object)u(t[n]);else{const r=e.exec(t[n]);r[1]&&(t[n]=t[n].replace(e,W(l,r[1])))}}async function f(t,e,n){const{schema:a,accountability:c,database:f}=n;l.$CURRENT_USER=c.user,l.$CURRENT_ROLE=c.role,l.$NOW=Math.round(Date.now()/1e3),l.$PAYLOAD=t,l.$KEYS=Array.isArray(e.keys)?e.keys:{},console.log("\n\n********** My hook:",e.event," **********"),console.log("********** payload:",t),console.log("********** meta:",e),console.log("********** $MACROS:",l);let p=e.event.replace("items.","").toUpperCase();if(void 0!==l&&["QUERY","READ","CREATE","UPDATE","PROMOTE","DELETE"].includes(p)){const t=new i(s.rules_collection,{schema:a,database:f}),n=await t.readByQuery({fields:["*"],filter:{event:{_eq:p},collection:{_eq:e.collection},active:{_eq:!0}}});for(const t of n){console.log("*** RULE:",t);const e=new i(t.related_collection,{schema:a,database:f});u(t.rule),console.log("*** RULE.rule after:",t.rule);const n={fields:["*"],filter:t.rule,limit:1},c=await e.readByQuery(n);if(Boolean(c.length)!=t.success){let e=` [${p}] ${t.name} : ${t.errorMessage}`;await o.logger.error(e);throw new(r("INVALID_PAYLOAD",e,400))}await o.logger.info(t.name+" succesful")}}return t}e("items.create",f),e("items.update",f),e("items.delete",f)}}],H=[],J=[];export{H as endpoints,z as hooks,J as operations};
